image: node:20-alpine

stages:
  - publish

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

publish:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - npm ci

    - npm run build

    - npm config set //registry.npmjs.org/:_authToken=$NPM_TOKEN

    - |
      PKG_VERSION=$(node -p "require('./package.json').version")
      TAG_VERSION=${CI_COMMIT_TAG#v}
      if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
        echo "‚ùå package.json version ($PKG_VERSION) != tag ($TAG_VERSION)"
        exit 1
      fi

    - npm publish --access public
